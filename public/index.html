<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EDCAN URL Shortener</title>
    <link rel="icon" href="favicon.png" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Material+Icons" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/font-nanumsquare/1.0.0/nanumsquare.css?ver=4.9.8" />
    <link rel="stylesheet" href="https://unpkg.com/vuetify/dist/vuetify.min.css" />
    <style>
      html {
        height: 100%;
        overflow: hidden;
      }
      body {
        background: #fafafa;
        word-break: keep-all;
      }
      .body,
      .application,
      .display-4,
      .display-3,
      .display-2,
      .display-1,
      .headline,
      .title {
        font-family: "Nanum Square", sans-serif;
      }
      .logo-white {
        padding: 20px;
        height: 30px;
        background: url(logo-white.png) center no-repeat;
        background-size: contain;
      }
      .divider {
        height: 30px;
        border-right: 2px solid #fff;
      }
    </style>
  </head>
  <body>
    <main>
      <v-app :dark="pageView">
        <v-snackbar v-model="snackbar" :timeout="3000" top>
          <span v-html="snackbarMsg"></span>
          <v-btn color="pink" flat @click="snackbar = false" v-text="'승인'"></v-btn>
        </v-snackbar>

        <v-layout v-if="pageView" align-center justify-center row>
          <v-flex xs11 sm8 md6>
            <v-layout align-center>
              <div :class="'logo-white'"></div>
              <div :class="'ml-3 divider'"></div>
              <h1 class="ml-3" v-text="'URL Shortener'"></h1>
            </v-layout>
            <v-form ref="form" v-model="form" onsubmit="return false">
              <v-layout class="mt-4">
                <v-text-field v-model="origin" label="URL 입력" color="#00B8D4" :rules="[rules.required, rules.url]" hint="단축된 URL은 공개되며 누구나 액세스할 수 있음" type="url" autofocus required></v-text-field>
                <v-btn flat color="#00B8D4" @click="loader = 'loading', shorten()" :disabled="loading || !form" :loading="loading"><v-icon class="mr-1" v-text="'flash_on'"></v-icon><span v-text="'URL 단축'"></span></v-btn>
              </v-layout>
            </v-form>
          </v-flex>
        </v-layout>

        <v-dialog v-model="dialog" persistent max-width="600px">
          <v-card>
            <v-card-title>
              <span class="headline" v-text="'알림'"></span>
            </v-card-title>
            <v-card-text>
              <v-layout align-center justify-center class="subheading mb-4" v-html="dialogMsg"></v-layout>
            </v-card-text>
            <v-card-actions>
              <v-spacer></v-spacer>
              <v-btn v-if="!dialogReload" color="info" @click="dialog = false" v-text="'승인'"></v-btn>
            </v-card-actions>
          </v-card>
        </v-dialog>

        <v-dialog v-model="dialogComplete" persistent max-width="600px">
          <v-card>
            <v-card-title> <span class="headline mr-2" v-text="'URL 단축 완료'"></span><v-icon v-text="'link'"></v-icon> </v-card-title>
            <v-card-text>
              <v-layout align-center justify-center>
                <v-text-field id="urlDisplay" color="#00B8D4" onclick="this.select();this.setSelectionRange(0,this.value.length)" :value="'https://l.edcan.kr/' + url" readonly></v-text-field>
                <v-btn icon @click="copy()"><v-icon v-text="'file_copy'"></v-icon></v-btn>
              </v-layout>
            </v-card-text>
            <v-card-actions>
              <v-spacer></v-spacer>
              <v-btn light @click="origin = '', url = '', dialogComplete = false" v-text="'닫기'"></v-btn>
            </v-card-actions>
          </v-card>
        </v-dialog>
      </v-app>
    </main>
    <noscript>
      <style>
        main {
          display: none;
        }
      </style>
      <div style="display:flex;align-items:center;justify-content:center;position:fixed;width:100%;height:100%;top:0;left:0;background:#1E1E1E;color:white;font-family:'Nanum Square',sans-serif;z-index:1000;">
        <h1>
          EDCANURL Shortner 구동을 위해서 JavaScript가 필요합니다.
        </h1>
      </div>
    </noscript>
    <script src="https://unpkg.com/vue/dist/vue.min.js"></script>
    <script src="https://unpkg.com/vuetify/dist/vuetify.min.js"></script>
    <script src="/__/firebase/5.9.1/firebase-app.js"></script>
    <script src="/__/firebase/5.9.1/firebase-auth.js"></script>
    <script src="/__/firebase/5.9.1/firebase-firestore.js"></script>
    <script>
      if (/*@cc_on!@*/ false) {
        location.replace("https://cdn.hyunwoo.kim/no_IE/#EDCAN_URL_Shortner");
      }
      firebase.initializeApp({
        apiKey: "AIzaSyDgLQ4IHI2gv3-NYyYB10SfCOhz5vF4YtM",
        authDomain: "edcan-url.firebaseapp.com",
        databaseURL: "https://edcan-url.firebaseio.com",
        projectId: "edcan-url",
        storageBucket: "edcan-url.appspot.com",
        messagingSenderId: "832850231119"
      });
      firebase.auth().signInAnonymously();
      const dbRef = firebase.firestore().collection("URLs"),
        hashStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",
        expression = /^(https:\/\/www\.|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,5}(:[0-9]{1,5})?(\/.*)?$/g,
        regex = new RegExp(expression);
      var v = new Vue({
        el: "v-app",
        data: () => ({
          snackbar: false,
          snackbarMsg: "",
          dialog: false,
          dialogMsg: null,
          dialogReload: false,
          dialogComplete: false,
          loader: null,
          loading: false,
          origin: "",
          url: "",
          pageView: false,
          form: false,
          rules: {
            required: value => !!value || "필수 사항입니다.",
            url: value => {
              return value.match(regex) || "HTTPS 프로토콜의 URL만 단축 가능.";
            }
          }
        }),

        watch: {
          loader() {
            const l = this.loader;
            this[l] = !this[l];
            setTimeout(() => (this[l] = false), 5000);
            this.loader = null;
          }
        },

        created: function() {
          if (!!window.location.pathname && window.location.pathname !== "/") {
            dbRef
              .doc(window.location.pathname.substr(1))
              .get()
              .then(function(doc) {
                if (doc.exists) {
                  location.replace(doc.data().origin.search("https://") === 0 ? doc.data().origin : "https://" + doc.data().origin);
                } else {
                  v.dialogShow("URL이 올바르지 않습니다.", true);
                }
              })
              .catch(function(error) {
                v.dialogShow("데이터를 읽어들이지 못하였습니다.", true);
                console.log("데이터를 읽어들이지 못하였습니다: ", error);
              });
          } else if (!!location.hash && location.hash !== "#") {
            dbRef
              .doc(location.hash.substr(1))
              .get()
              .then(function(doc) {
                if (doc.exists) {
                  location.replace(doc.data().origin.search("https://") === 0 ? doc.data().origin : "https://" + doc.data().origin);
                } else {
                  v.dialogShow("URL이 올바르지 않습니다.", true);
                }
              })
              .catch(function(error) {
                v.dialogShow("데이터를 읽어들이지 못하였습니다.", true);
                console.log("데이터를 읽어들이지 못하였습니다: ", error);
              });
          } else {
            this.pageView = true;
          }
        },

        methods: {
          snackbarShow(msg) {
            this.snackbar = true;
            this.snackbarMsg = msg;
          },
          dialogShow(msg, reload) {
            this.dialog = true;
            this.dialogMsg = msg;
            this.dialogReload = reload;
          },
          shorten() {
            v.rand();
            dbRef
              .doc(v.url)
              .get()
              .then(function(doc) {
                if (!doc.exists) {
                  v.complete();
                } else {
                  v.shorten();
                }
              })
              .catch(function(error) {
                v.dialogShow("URL을 단축하지 못하였습니다.", true);
                console.log("URL을 단축하지 못하였습니다: ", error);
              });
          },
          rand() {
            this.url = "";
            for (let i = 0; i < 4; i++) {
              this.url += hashStr.charAt(Math.floor(Math.random() * hashStr.length));
            }
          },
          complete() {
            dbRef
              .doc(v.url)
              .set({
                created: firebase.firestore.FieldValue.serverTimestamp(),
                origin: v.origin
              })
              .then(function() {
                v.dialogComplete = true;
                setTimeout(function() {
                  document.querySelector("#urlDisplay").focus();
                  document.querySelector("#urlDisplay").select();
                }, 500);
              })
              .catch(function(error) {
                v.dialogShow("URL을 단축하지 못하였습니다.", true);
                console.log("URL을 단축하지 못하였습니다: ", error);
              });
          },
          copy() {
            let el = document.createElement("textarea");
            el.value = "https://l.edcan.kr/" + this.url;
            document.body.appendChild(el);
            el.select();
            document.execCommand("cut");
            if (el.value != "https://l.edcan.kr/" + v.url) {
              v.snackbarShow("브라우저에서 클립보드 복사를 지원하지 않습니다.<br>생성된 URL을 수동으로 복사하여 주십시오.");
            } else {
              v.snackbarShow("복사되었습니다.");
            }
            document.body.removeChild(el);
          }
        }
      });
    </script>
  </body>
</html>
